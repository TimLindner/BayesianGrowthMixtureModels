---
title: "Table of contents"
output:
  html_document:
    toc: true
    toc_depth: 2
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, include = FALSE}
# README
# required files:
# Model1TwoClasses_Ysim.xlsx ( to load simulated dependent variable )
# Model1TwoClasses_Fit.rds ( to load model fit )

# if necessary, manually adjust descriptive statistics and
# data simulation section
```


# Color coding
* <span style="color: darkturquoise;">darkturquoise</span> for mixture proportion parameters
* <span style="color: blueviolet;">blueviolet</span> for Normal distribution parameters ( i.e., constant, linear trend component, and standard deviation )
* <span style="color: deeppink;">deeppink</span> for predicted dependent variable
* <span style="color: orange;">orange</span> for simulated parameters and observed dependent variable


# Descriptive statistics
* $N = 400$

* $T = 10$


# Data simulation
* $y^{obs}_{n,t} \sim 0.9 \, Normal(-5 -0.5 \, x_{n,t},0.25) + 0.1 \, Normal(6 + 1 \, x_{n,t},0.75) \quad \text{for } n = 1,...,200$

* $y^{obs}_{n,t} \sim 0.1 \, Normal(-5 -0.5 \, x_{n,t},0.25) + 0.9 \, Normal(6 + 1 \, x_{n,t},0.75) \quad \text{for } n = 201,...,N$


```{r, include = FALSE}
# preparation ####
# set working directory
setwd("C:/Users/Diiim/Documents/ResearchAssistance")

# set decimals to digits instead of scientific
options(scipen = 999)

# load packages
library(readxl)
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)


# estimated data ####
# number of latent classes
C <- 2

# load model fit
m_fit <- readRDS("SimulationStudyResult/Model1TwoClasses_Fit.rds")
m_fit_params <- rstan::extract(m_fit)

# predicted dependent variable
Y_pred <- m_fit_params$Y_pred

# number of individuals
N <- dim(Y_pred[1,,])[1]

# number of time periods
no_periods <- dim(Y_pred[1,,])[2]

# time periods
time_periods <- 0:(no_periods-1)
X <- matrix(data = time_periods, nrow = N, ncol = no_periods, byrow = TRUE)

# middle 90% credible intervals for Y_pred
Y_pred_CI_lower <- matrix(data = 0, nrow = N, ncol = no_periods)
Y_pred_CI_upper <- matrix(data = 0, nrow = N, ncol = no_periods)
for (t in 1:no_periods) {
  for (n in 1:N) {
    Y_pred_CI_lower[n,t] <- quantile(Y_pred[,n,t], prob = 0.05)
    Y_pred_CI_upper[n,t] <- quantile(Y_pred[,n,t], prob = 0.95)
  }
}


# simulated data ####
# simulated mixture proportions step 1
Pi_sim <- matrix(data = 0, nrow = N, ncol = C)
for (n in 1:round(N/2)) {
  Pi_sim[n,] <- c(0.9,0.1)
}

# simulated mixture proportions step 2
for (n in (round(N/2)+1):N) {
  Pi_sim[n,] <- c(0.1,0.9)
}

# simulated constants
beta_0_sim <- c(-5,6)

# simulated linear trend components
beta_1_sim <- c(-0.5,1)

# simulated standard deviations for Normal distributions
sigma_sim <- c(0.25,0.75)

# load observed dependent variable
Y_obs <-
  data.frame(read_excel("SimulationStudyData/Model1TwoClasses_Yobs.xlsx",
                        sheet = "Sheet 1"))


# colors ####
pink_transp <- rgb(red = 255,
                   green = 20,
                   blue = 147,
                   max = 255,
                   alpha = 25,
                   names = "deeppink1")
```


# Trace plots
## Mixture proportions
```{r}
for (n in 1:N) {
  for (c in 1:C) {
    plot(m_fit_params$Pi[,n,c],
         type = "l",
         col = "darkturquoise",
         main = "",
         xlab = "",
         ylab = "")
    
    grid(nx = NA, ny = NULL)
    par(new = TRUE)
    
    plot(m_fit_params$Pi[,n,c],
         type = "l",
         col = "darkturquoise",
         main = paste("Individual n =", n, "and class c =", c),
         xlab = "Sampling iteration",
         ylab = "Pi")
  }
}
```

## Constants
```{r}
for (c in 1:C) {
  plot(m_fit_params$beta_0[,c],
       type = "l",
       col = "blueviolet",
       main = "",
       xlab = "",
       ylab = "")
  
  grid(nx = NA, ny = NULL)
  par(new = TRUE)
  
  plot(m_fit_params$beta_0[,c],
       type = "l",
       col = "blueviolet",
       main = paste("Class c =", c),
       xlab = "Sampling iteration",
       ylab = "beta_0")
}
```


## Linear trend components
```{r}
for (c in 1:C) {
  plot(m_fit_params$beta_1[,c],
       type = "l",
       col = "blueviolet",
       main = "",
       xlab = "",
       ylab = "")
  
  grid(nx = NA, ny = NULL)
  par(new = TRUE)
  
  plot(m_fit_params$beta_1[,c],
       type = "l",
       col = "blueviolet",
       main = paste("Class c =", c),
       xlab = "Sampling iteration",
       ylab = "beta_1")
}
```


## Standard deviations for Normal distributions
```{r}
for (c in 1:C) {
  plot(m_fit_params$sigma[,c],
       type = "l",
       col = "blueviolet",
       main = "",
       xlab = "",
       ylab = "")
  
  grid(nx = NA, ny = NULL)
  par(new = TRUE)
  
  plot(m_fit_params$sigma[,c],
       type = "l",
       col = "blueviolet",
       main = paste("Class c =", c),
       xlab = "Sampling iteration",
       ylab = "sigma")
}
```


# Posterior
## Mixture proportions
```{r}
for (n in 1:N) {
  for (c in 1:C) {
    hist(m_fit_params$Pi[,n,c],
         xlim = c(min(m_fit_params$Pi[,n,c],Pi_sim[n,c]),
                  max(m_fit_params$Pi[,n,c],Pi_sim[n,c])),
         col = "darkturquoise",
         border = FALSE,
         main = "",
         xlab = "")
    
    grid()
    par(new = TRUE)
    
    hist(m_fit_params$Pi[,n,c],
         xlim = c(min(m_fit_params$Pi[,n,c],Pi_sim[n,c]),
                  max(m_fit_params$Pi[,n,c],Pi_sim[n,c])),
         col = "darkturquoise",
         border = FALSE,
         main = paste("Individual n =", n, "and class c =", c),
         sub = "( the orange line shows the simulated parameter )",
         xlab = "Pi")
    abline(v = Pi_sim[n,c],
           lwd = 2,
           col = "orange")
    box()
  }
}
```

## Constants
```{r}
for (c in 1:C) {
  hist(m_fit_params$beta_0[,c],
       xlim = c(min(m_fit_params$beta_0[,c],beta_0_sim[c]),
                max(m_fit_params$beta_0[,c],beta_0_sim[c])),
       col = "blueviolet",
       border = FALSE,
       main = "",
       xlab = "")
  
  grid()
  par(new = TRUE)
  
  hist(m_fit_params$beta_0[,c],
       xlim = c(min(m_fit_params$beta_0[,c],beta_0_sim[c]),
                max(m_fit_params$beta_0[,c],beta_0_sim[c])),
       col = "blueviolet",
       border = FALSE,
       main = paste("Class c =", c),
       sub = "( the orange line shows the simulated parameter )",
       xlab = "beta_0")
  abline(v = beta_0_sim[c],
         lwd = 2,
         col = "orange")
  box()
}
```


## Linear trend components
```{r}
for (c in 1:C) {
  hist(m_fit_params$beta_1[,c],
       xlim = c(min(m_fit_params$beta_1[,c],beta_1_sim[c]),
                max(m_fit_params$beta_1[,c],beta_1_sim[c])),
       col = "blueviolet",
       border = FALSE,
       main = "",
       xlab = "")
  
  grid()
  par(new = TRUE)
  
  hist(m_fit_params$beta_1[,c],
       xlim = c(min(m_fit_params$beta_1[,c],beta_1_sim[c]),
                max(m_fit_params$beta_1[,c],beta_1_sim[c])),
       col = "blueviolet",
       border = FALSE,
       main = paste("Class c =", c),
       sub = "( the orange line shows the simulated parameter )",
       xlab = "beta_1")
  abline(v = beta_1_sim[c],
         lwd = 2,
         col = "orange")
  box()
}
```


## Standard deviations for Normal distributions
```{r}
for (c in 1:C) {
  hist(m_fit_params$sigma[,c],
       xlim = c(min(m_fit_params$sigma[,c],sigma_sim[c]),
                max(m_fit_params$sigma[,c],sigma_sim[c])),
       col = "blueviolet",
       border = FALSE,
       main = "",
       xlab = "")
  
  grid()
  par(new = TRUE)
  
  hist(m_fit_params$sigma[,c],
       xlim = c(min(m_fit_params$sigma[,c],sigma_sim[c]),
                max(m_fit_params$sigma[,c],sigma_sim[c])),
       col = "blueviolet",
       border = FALSE,
       main = paste("Class c =", c),
       sub = "( the orange line shows the simulated parameter )",
       xlab = "sigma")
  abline(v = sigma_sim[c],
         lwd = 2,
         col = "orange")
  box()
}
```


# Posterior predictive check via middle 90% credible interval
```{r}
for (n in 1:N) {
  y_upper <- Y_pred_CI_upper[n,]
  y_lower <- Y_pred_CI_lower[n,]
  x <- X[n,]
  
  plot(x = x,
       y = c(max(y_upper),
             min(y_lower),
             max(Y_obs[n,]),
             min(Y_obs[n,]),
             rep(max(y_upper), times = no_periods-4)),
       type="l",
       col = "white",
       main = paste("Individual n =", n),
       sub = "( the orange line shows the observed dependent variable )",
       xlab = "t",
       ylab = "Y_pred")
  
  grid(nx = NA, ny = NULL)
  par(new = TRUE)
  
  polygon(x = c(x, rev(x)),
          y = c(y_upper, rev(y_lower)),
          col = pink_transp,
          lty = 0)
  lines(x = x,
        y = Y_obs[n,],
        lwd = 2,
        col = "orange")
  box()
}
```


